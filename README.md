# HIPS - 主机入侵防御系统

本项目是一个通过 Linux 内核技术实现的简单主机入侵防御系统（HIPS），旨在演示如何在操作系统内核层面直接进行系统安全监控与防护。

它的核心功能是实时监控系统上所有新进程的创建，并根据一个可以动态配置的规则集，在进程执行之前就将其同步拦截，从而阻止潜在的恶意程序运行。

项目提供了两种实现方式，分别基于 **eBPF** 和 **Kprobes**，以展示解决同一问题的不同技术路径。

## 核心功能

- **实时进程监控与拦截**: 在 `execve` 系统调用层面挂钩，实现对新进程的实时、同步拦截。
- **动态规则配置**: 支持在运行时动态更新拦截/放行规则，无需重新编译或加载。
- **高性能**: 核心逻辑在内核态执行，开销极低。
- **结构化日志**: 将检测和拦截事件以结构化格式（JSON 或 dmesg）记录下来，便于分析。

## 版本对比

本项目提供了两种技术实现，它们各有优劣：

| 特性 | eBPF 版本 (`ebpf_version`) | Kprobes 版本 (`kprobes_version`) |
| :--- | :--- | :--- |
| **核心技术** | eBPF (via `bcc`) | Kprobes |
| **安全性** | **极高**。eBPF 代码经过内核验证器(Verifier)检查，无法导致内核崩溃。 | **有风险**。作为传统内核模块，代码中的缺陷可能直接导致内核恐慌(Kernel Panic)。 |
| **控制语言** | Python | C |
| **配置方式** | `config.json` 文件 | `/proc/hips_blacklist` 虚拟文件 |
| **规则丰富度** | **非常丰富**。支持基于文件名、命令行、父进程、文件哈希的复杂规则。 | **简单**。仅支持基于可执行文件名的黑名单。 |
| **依赖** | `bcc`, `libbpfcc`, 内核头文件 | `make`, `gcc`, 内核头文件 |
| **适用场景** | 追求安全性、灵活性和现代化特性的生产或实验环境。 | 用于教学或深入理解内核模块工作原理的底层探索。 |

---

## 项目结构

```
/
├── ebpf_version/           # eBPF 版本实现
│   ├── hips.py             # 主程序 (包含 eBPF C 代码和 Python 控制逻辑)
│   ├── config.json         # 规则配置文件
│   └── README.md           # eBPF 版本详细说明
│
├── kprobes_version/        # Kprobes 版本实现
│   ├── hips_kmod.c         # 内核模块源代码
│   ├── Makefile            # 编译脚本
│   └── README.md           # Kprobes 版本详细说明
│
└── README.md               # 本文件
```

## 快速开始

**⚠️ 警告: 在内核空间运行代码具有一定风险，强烈建议在虚拟机中进行测试。**

1.  **选择一个版本**: 根据上面的版本对比，选择您感兴趣的实现。
2.  **阅读详细文档**: 进入 `ebpf_version` 或 `kprobes_version` 目录，并仔细阅读其内部的 `README.md` 文件。
3.  **遵循指导**: 按照对应版本 `README.md` 中的 “**安装与使用**” 部分进行操作。

### 简要流程

- **对于 eBPF 版本**:
  1.  安装 `python3-bpfcc` 等依赖。
  2.  编辑 `config.json` 文件定义规则。
  3.  运行 `sudo python3 hips.py`。
  4.  在 `hips.log.json` 中查看日志。

- **对于 Kprobes 版本**:
  1.  安装 `make` 和 `gcc` 等编译工具。
  2.  执行 `make` 编译内核模块 (`.ko` 文件)。
  3.  使用 `sudo insmod hips_kmod.ko` 加载模块。
  4.  通过 `echo "程序名" > /proc/hips_blacklist` 添加黑名单。
  5.  使用 `dmesg` 查看拦截日志。
  6.  使用 `sudo rmmod hips_kmod` 卸载模块。

## 贡献

欢迎对本项目进行贡献！您可以：

- 报告 Bug。
- 提交新的功能建议。
- 改进代码或文档。

请通过提交 Pull Request 的方式参与贡献。

## 许可证

本项目采用 [MIT](LICENSE) 许可证。